<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>public/javascripts/app/components/Reel.js - kingkong</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="kingkong" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/WinLine.html">WinLine</a></li>
                                <li><a href="../classes/.html"></a></li>
                                <li><a href="../classes/BigWinComponent.html">BigWinComponent</a></li>
                                <li><a href="../classes/GaffButton.html">GaffButton</a></li>
                                <li><a href="../classes/GaffMenuComponent.html">GaffMenuComponent</a></li>
                                <li><a href="../classes/GameComponent.html">GameComponent</a></li>
                                <li><a href="../classes/Reel.html">Reel</a></li>
                                <li><a href="../classes/ReelsComponent.html">ReelsComponent</a></li>
                                <li><a href="../classes/CommandQueue.html">CommandQueue</a></li>
                                <li><a href="../classes/WinLinesComponent.html">WinLinesComponent</a></li>
                                <li><a href="../classes/Game.html">Game</a></li>
                                <li><a href="../classes/Preloader.html">Preloader</a></li>
                                <li><a href="../classes/ServerInterface.html">ServerInterface</a></li>
                                <li><a href="../classes/SignalDispatcher.html">SignalDispatcher</a></li>
                                <li><a href="../classes/QueueFactory.html">QueueFactory</a></li>
                                <li><a href="../classes/Utils.html">Utils</a></li>
                                <li><a href="../classes/Main.html">Main</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: public/javascripts/app/components/Reel.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*! kingkong 0.0.1 - 2015-02-04
* Copyright (c) 2015 Licensed @HighFiveGames */

var G = G || {};

(function () {
	&quot;use strict&quot;;

	/**
	 * One Reel defined by this class. Contains a sprite map for mapping sprite ids to symbol sprites.
	 * Sets up and executes the spin animation Tween when reels are spun.
	 * Stops the tween when spinning is ended and signals to the ReelComponent.
	 * @class Reel
	 * @extends createjs.Container
	 * @constructor
	 */
	var Reel = function() {
		this.Container_constructor();
	};

	var p = createjs.extend(Reel, createjs.Container);
	p.constructor = Reel;

	/**
	 * array of symbolData to map
	 * @property reelData
	 * @type {Array}
	 */
	p.reelData = [];

	p.setup = null;

	p.symbolSprites = null;

	p.containers = {
		main: this,
		wraps: []
	};

	p.logEnabled = false;

	p.scheduleSpinStop = -2;

	/**
	 * Dynamically alter the speed of reels by changing this percentage:
	 * eg. 0.5 = half speed reels
	 * @type {number}
	 */
	p.speedPercentage = 0.5;

	/**
	 * Maximum Speed the reels can spin in pixels per second
	 * @const speedConstant
	 * @default 6000
	 * @type {number}
	 */
	p.speedConstant = 6000;

	/**
	 * @property spriteMap
	 * @type {string[]}
	 */
	p.spriteMap = [&#x27;ww&#x27;,&#x27;m1&#x27;, &#x27;m2&#x27;, &#x27;m3&#x27;, &#x27;m4&#x27;, &#x27;f5&#x27;, &#x27;f6&#x27;, &#x27;f7&#x27;, &#x27;f8&#x27;, &#x27;f9&#x27;, &#x27;f0&#x27;, &#x27;d1&#x27;, &#x27;d2&#x27;, &#x27;d3&#x27;, &#x27;d4&#x27;, &#x27;b1&#x27;, &#x27;b2&#x27;];

	p.tween = null;

	p.scheduleSpeedChange = false;

	p.reelSpinEnd = new signals.Signal();

	p.stopTimeout = 0;

	p.spinResultIndex = 0;

	p.init = function(setup, symbolSprites, reelData) {
		this.setup = setup;
		this.symbolSprites = symbolSprites;
		this.reelData = reelData;
	};

	p.modifyReelData = function(reelData) {
		var i, j, symbolSprite;
		for (i = 0; i &lt; this.containers.wraps.length; i++) {
			var wrap = this.containers.wraps[i];
			for (j = 0; j &lt; wrap.getNumChildren(); j++) {
				symbolSprite = wrap.getChildAt(j);
				symbolSprite.gotoAndStop(this.spriteMap[reelData[j]]);
			}
		}
	};

	p.drawReel = function() {
		var symbolW = this.setup.symbolW;
		var symbolH = this.setup.symbolH;
		var symbolMarginB = this.setup.symbolMarginBottom;
		var container, len = this.reelData.length;
		var l, j, sp, debugSh, gp, text, text2;
		var reelHeight = this.reelData.length * symbolH + this.reelData.length * symbolMarginB;
		var wrapPosY;
		for (l = 0; l &lt; 2; l++) {
			//creates 2 reel wrappers
			var wrap = new createjs.Container();
			this.addChild(wrap);

			for (j = 0; j &lt; len; j++) {
				//creates a symbol for every index in reelData array
				container = new createjs.Container();
				sp = new createjs.Sprite(this.symbolSprites, this.spriteMap[this.reelData[j]]);
				container.addChild(sp);
				if (this.setup.devMode) {
					var wrapColor = l === 0? &quot;#00ff00&quot; : &quot;#ff0000&quot;;
					debugSh = new createjs.Shape();
					gp = debugSh.graphics;
					gp.setStrokeStyle(2);
					gp.beginStroke(wrapColor);
					gp.beginFill(&quot;rgba(128,3,95,0.3)&quot;);
					gp.drawRect(0, 0, symbolW, symbolH);
					gp.endFill().endStroke();
					container.addChild(debugSh);
					text = new createjs.Text(&quot;SymbolIndex:&quot; + j, &quot;12px Arial&quot;, &quot;#ffffff&quot;);
					text2 = new createjs.Text(&quot;Wrap:&quot; + l, &quot;12px Arial&quot;, &quot;#ffffff&quot;);
					text.x = 0;
					container.addChild(text);
					container.addChild(text2);
					text2.y = 14;
				}
				wrap.addChild(container);
				container.y = (symbolH * j + symbolMarginB * j);
			}
			wrapPosY = wrap.y = -l * reelHeight;
			this.containers.wraps.push(wrap);

			for (j = 0; j &lt; 2; j++) {
				//2 rows of symbols to buffer above and below the symbol wrappers
				var symbolBufferWrap = new createjs.Container();
				this.addChild(symbolBufferWrap);
				container = new createjs.Container();
				var tempSymbolIndex = len - 2 + j - (l * (len - 2));
				sp = new createjs.Sprite(this.symbolSprites, this.spriteMap[this.reelData[tempSymbolIndex]]);
				container.addChild(sp);
				container.y = (symbolH * j + symbolMarginB * j);
				symbolBufferWrap.addChild(container);
				symbolBufferWrap.y = -reelHeight - 2 * (symbolH - symbolMarginB) + (l * (2 * (symbolH - symbolMarginB) + reelHeight * 2));
				this.containers.wraps.push(symbolBufferWrap);

				if (this.setup.devMode) {
					debugSh = new createjs.Shape();
					gp = debugSh.graphics;
					gp.setStrokeStyle(2);
					gp.beginStroke(&#x27;#0000ff&#x27;);
					gp.drawRect(0,0,symbolW, symbolH);
					gp.endFill().endStroke();
					container.addChild(debugSh);
					text = new createjs.Text(&quot;SymbolIndexBuffer&quot;, &quot;12px Arial&quot;, &quot;#ffffff&quot;);
					text2 = new createjs.Text(&quot;Wrap:&quot; + (l + 2), &quot;12px Arial&quot;, &quot;#ffffff&quot;);
					text.x = 0;
					container.addChild(text);
					container.addChild(text2);
					text2.y = 14;
				}
			}
		}
	};

	/**
	 * Spin this reel to the specified index position with a given delay
	 * @method spinToIndex
	 * @param {Number} index - index of symbol on this reel to spin to (top left of reel should spin to this index)
	 * @param {Number} delay - Millis til this spin will start
	 */
	p.spinToIndex = function(index, delay) {
		var self = this;
		var symbolH = this.setup.symbolH;
		var symbolMarginB = this.setup.symbolMarginBottom;
		var symbolsLen = this.reelData.length;
		var spinDelay = delay || 0;
		var reelH = symbolH * symbolsLen + symbolMarginB * symbolsLen;
		var yPos = reelH;
		var tweenTime = this.getTime();

		this.y = -this.spinResultIndex * symbolH + -this.spinResultIndex * symbolMarginB;

		this.spinResultIndex = index;
		this.scheduleSpinStop = -1;

		if (this.logEnabled) {
			console.log(&#x27;Tween_Start:&#x27;, this.y, yPos, tweenTime);
			console.log(&#x27;SymbolsHeight:&#x27;, symbolH * symbolsLen + symbolMarginB * symbolsLen);
		}

		createjs.Tween.get(this)
			.wait(delay)
			.play(
				createjs.Tween.get(this, {loop: false, paused:true})
					.to({y:yPos}, tweenTime, createjs.Ease.getElasticIn(2,2))
					.call(this.loopSpin)

		);


		this.stopTimeout = setTimeout(function() {
			self.fastStop();
		}, this.setup.reelAnimation.duration + spinDelay);
	};

	p.getTime = function() {
		var symbolH = this.setup.symbolH;
		var symbolMarginB = this.setup.symbolMarginBottom;
		var symbolsLen = this.reelData.length;
		var distanceInPixels = symbolH * symbolsLen + symbolMarginB * symbolsLen;
		return distanceInPixels / (this.speedPercentage * this.speedConstant / 1000);
	};

	p.loopSpin = function() {
		var symbolH = this.setup.symbolH;
		var symbolMarginB = this.setup.symbolMarginBottom;
		var symbolsLen = this.reelData.length;
		var reelH = symbolH * symbolsLen + symbolMarginB * symbolsLen;
		var tweenTime = this.getTime();
		var yPos;
		if (this.scheduleSpinStop === -1){
			this.y = 0;
			yPos = reelH;
		} else {
			return;
		}

		if (this.logEnabled) {
			console.log(&#x27;Tween_Loop:&#x27;, this.y, yPos, tweenTime);
		}

		createjs.Tween
			.get(this, {override: true, loop: false })
			.to({y: yPos}, tweenTime, createjs.Ease.linear())
			.call(this.loopSpin)
			.on(&quot;change&quot;, this.onYPosUpdate);
	};

	p.getStopTime =function(index) {
		var symbolH = this.setup.symbolH;
		var symbolMarginB = this.setup.symbolMarginBottom;
		var symbolsLen = this.reelData.length;
		var reelH = symbolsLen * symbolH + symbolsLen * symbolMarginB;
		var distanceInPixels = (symbolH * index + symbolMarginB * index) + reelH;
		return distanceInPixels / (this.speedPercentage * this.speedConstant / 1000);
	};

	p.stopSpin = function(index) {
		this.scheduleSpinStop = -2;
		var symbolH = this.setup.symbolH;
		var symbolMarginB = this.setup.symbolMarginBottom;
		var symbolsLen = this.reelData.length;
		var reelH = (symbolH * symbolsLen) + (symbolMarginB * symbolsLen);
		var yPos = -(symbolH * index + symbolMarginB * index) + reelH;
		var stopTime = this.getStopTime(index);
		var easeAmp = 1 + index * 0.01;
		var easeTime = 1 - index * 0.02;

		setTimeout(function() {
			createjs.Sound.play(&quot;reelstop1&quot;);
		}, stopTime - 300);

		this.y = 0;

		if (this.logEnabled) {
			console.log(&#x27;Tween_Stop&#x27;, this.y, yPos, stopTime, &#x27;easeAmp=&#x27;, easeAmp);
		}

		createjs.Tween
			.get(this, {override: true, loop:false})
			.to({y: yPos}, stopTime, createjs.Ease.getElasticOut(easeAmp,easeTime))
			//.to({y: yPos}, stopTime)
			.call(this.handleSpinComplete)
			.on(&quot;change&quot;, this.onYPosUpdate);
	};

	p.onYPosUpdate = function() {
		var self = this.target;
		if (self.logEnabled) {
			console.log(&#x27;this.Container Y=&#x27;, Math.round(self.y));
		}

	};

	p.fastStop = function() {
		if (this.scheduleSpinStop &gt; -2) {
			clearInterval(this.stopTimeout);
			this.stopSpin(this.spinResultIndex);
		}
	};

	p.handleSpinComplete = function() {
		this.reelSpinEnd.dispatch();
	};


	p.spinSpeedIncrement = function(val) {
		if (this.speedPercentage !== val) {
			this.speedPercentage = val;
			this.scheduleSpeedChange = true;
		}
	};



	G.Reel = createjs.promote(Reel, &quot;Container&quot;);

})();
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
